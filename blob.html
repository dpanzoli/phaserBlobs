
<html>
<meta charset="utf-8">
<script src="phaser.min.js"></script>
<script>

var config = {
    type: Phaser.WEBGL,
    width: 800,
    height: 800,
    backgroundColor: '#000',
    parent: 'phaser-example',
    scene: {
        preload: preload,
        create: create,
		update: update
    },
	physics: {
        default: 'arcade',
        arcade: {
            debug: false
        }
    },
};

var game = new Phaser.Game(config);

var avatar, grosBlob, directionArrow;

function preload ()
{
    this.load.atlas('flares', 'flares.png', 'flares.json');
	this.load.spritesheet('faces','faces.png', { frameWidth: 64, frameHeight: 64 });
	
	this.load.spritesheet('arrow','arrow.png',{ frameWidth: 50, frameHeight: 80 });
}

function create ()
{
    var particles = this.add.particles('flares');
	var blobGroup = this.physics.add.group({
		bounceX: 1,
		bounceY: 1,
		collideWorldBounds: true
	});

	avatar = this.add.container(200,150);
	this.physics.world.enable(avatar);
	avatar.vitesse = 0;
	avatar.direction = 0;
	avatar.body.setCircle(50,-50,-50);
	grosBlob = this.add.image(0, 0, 'faces',0);
	grosBlob.setInteractive();
	//grosBlob.setCircle(40,-24,-24);
	grosBlob.emitter = particles.createEmitter({
		frame:  ['blue'],
		quantity: 10,
        lifespan: 1000,
        blendMode: 'ADD',
		emitZone: {source: new Phaser.Geom.Circle(0, 0, 25)},
		follow : avatar,
		scale: { start: 1, end: 0, ease: 'linear' }
    });
	blobGroup.add(avatar);
	avatar.add(grosBlob);
	//ajout de la flèche de contrôle
	var controlArrow = this.add.container(0,0);
	controlArrow.visible = false; //par défaut
	directionArrow = this.add.image(100,0,'arrow');
	controlArrow.add(directionArrow);
	avatar.add(controlArrow);
/*	
	var moyenBlob = this.physics.add.image(200,300, 'face');
	moyenBlob.setInteractive();
	moyenBlob.setCircle(32,-16,-16);
	blobGroup.add(moyenBlob);
	moyenBlob.emitter = particles.createEmitter({
 		frame:  ['green'] ,
		quantity: 10,
		scale: { start: 0.5, end: 0, ease: 'linear' },
        lifespan: 500,
        blendMode: 'ADD',
		emitZone: {source: new Phaser.Geom.Circle(0, 0, 25)},
		follow : moyenBlob,
		//followOffset: {x:100, y:100},
    });

	var petitBlob = this.physics.add.image(200,450, 'face');
	petitBlob.setInteractive();
	petitBlob.setCircle(32,-16,-16);
	petitBlob.setScale(0.66);
	blobGroup.add(petitBlob);
	petitBlob.emitter = particles.createEmitter({
 		frame:  ['yellow'] ,
		quantity: 20,
		scale: { start: 0.3, end: 0, ease: 'linear' },
        lifespan: 300,
        blendMode: 'ADD',
		emitZone: {source: new Phaser.Geom.Circle(0, 0, 20)},
		follow : petitBlob,
		//followOffset: {x:-100, y:0},
    });	

	//Les blobs subissent la physique
	this.physics.add.collider(blobGroup, blobGroup);
*/	
	this.input.on('pointermove', function (pointer) {
		
		avatar.direction = Phaser.Math.Angle.Between(
			avatar.x,
			avatar.y,
			pointer.worldX,
			pointer.worldY
		);
		controlArrow.setRotation(avatar.direction);
		
		var distance = Phaser.Math.Distance.Between(
			avatar.x,
			avatar.y,
			pointer.worldX,
			pointer.worldY
		);
		if (distance<80) {
			controlArrow.visible = false;
			avatar.vitesse = 0;
		} else {
			controlArrow.visible = true;
			var norm = (Math.min(distance,300) - 80)/300
			//modifier la taille de la flèche
			directionArrow.setScale(norm*0.75+0.25);
			//modifier la distance de la flèche
			directionArrow.x = 80 + (norm*50);
			avatar.vitesse = norm;
		}
	});
	
	//creation du triangle pour la direction
/*	particles.createEmitter({
		frame:  ['blue'],
		quantity: 100,
        lifespan: 1000,
        blendMode: 'ADD',
		emitZone: {source: new Phaser.Geom.Triangle(400, 300, 600,500,400,700)},
		scale: { start: 1, end: 0, ease: 'linear' }
    });
*/
}

function update(elapsed, delta) {
	
	if (this.input.activePointer.isDown) {
		directionArrow.setFrame(1);
		if (avatar.vitesse > 0.5) 
			grosBlob.setFrame(1);
		else 
			grosBlob.setFrame(0);
		this.physics.velocityFromRotation(
			avatar.direction, 
			avatar.vitesse*delta*25,
			avatar.body.velocity
		);
	} else {
		grosBlob.setFrame(0);
		directionArrow.setFrame(0);
		avatar.body.setVelocity(0,0);
	}
	
	
	
}


</script>

</html>